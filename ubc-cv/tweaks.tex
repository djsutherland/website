% Adapted from Ron Garcia's UBC CV
% Adapted from Kevin Leyton-Brown's CV Template
% Adapted from Helge Rhodin's CV Template

\usepackage[USenglish]{babel}
\usepackage[utf8]{inputenc}
\usepackage{csquotes}

\usepackage{longtable}  % Support tables that span pages
\usepackage{xcolor}
\usepackage{hhline}
\usepackage{booktabs} % Commands for book-quality tables
\usepackage{comment} % Enable and disable "blurbs" (for Evaluative CVs)
\usepackage{multirow} % Better looking multi-row table headers
\usepackage{enumitem} % Better list control
\usepackage{lipsum} % Lipsum
\usepackage{titlesec}

% Font to arial
\usepackage{helvet}
\renewcommand{\familydefault}{\sfdefault}

% https://tex.stackexchange.com/a/443445/9019
\newcommand{\ulsection}[2][-1pt]{\section{\texorpdfstring{\dunderline[#1]{1pt}{#2}}{#2}}}
\newcommand\dunderline[3][-1pt]{{%
  \sbox0{#3}%
  \ooalign{\copy0\cr\rule[\dimexpr#1-#2\relax]{\wd0}{#2}}}}

%%
%% Logo / Header
%%
\usepackage{graphicx}
\newcommand{\UBClogo}{\includegraphics[height=9pt]{figs/UBC-logo-grey}~}
\newcommand{\bigUBClogo}{\includegraphics[height=26pt]{figs/UBC-logo-grey}~}
\newcommand{\UBCheader}[1]{\begin{center} \begin{minipage}{.065\textwidth}\bigUBClogo\end{minipage}~\begin{minipage}{.5\textwidth}\centering{\includegraphics[width=\textwidth]{figs/ubc-logo-2018-wordmark-black-cmyk}}\\{\bf\it #1}\end{minipage}~~\begin{minipage}{.1\textwidth}~\end{minipage}\end{center}}
%\newcommand{\UBCheader}[1]{\begin{center} \begin{minipage}{.1\textwidth}\bigUBClogo\end{minipage}~~\begin{minipage}{.5\textwidth}\centering{\bf THE UNIVERSITY OF BRITISH COLUMBIA} \\{\bf\it #1}\end{minipage}~~\begin{minipage}{.1\textwidth}~\end{minipage}\end{center}}


%%% Footnote stuff.
\usepackage[bottom,para]{footmisc}

% https://tex.stackexchange.com/a/683741/9019
\usepackage{perpage}
\newcounter{switched}\MakePerPage{switched}\newcommand{\switched}{\stepcounter{switched}\footnotemark[1000]\ifnum \value{switched}=1 \footnotetext[1000]{Switched to my supervision at this point.}\fi}
\newcounter{paid}\MakePerPage{paid}\newcommand{\paid}{\stepcounter{paid}\footnotemark[1001]\ifnum \value{paid}=1 \footnotetext[1001]{Expenses paid.}\fi}
\newcounter{competitive}\MakePerPage{competitive}\newcommand{\competitive}{\stepcounter{competitive}\footnotemark[1002]\ifnum \value{competitive}=1 \footnotetext[1002]{Competitively selected.}\fi}
\newcounter{compequiv}\MakePerPage{compequiv}\newcommand{\compequiv}{\stepcounter{compequiv}\footnotemark[1003]\ifnum \value{compequiv}=1 \footnotetext[1003]{Estimated equivalent cost for computational resources.}\fi}
\newcounter{virtual}\MakePerPage{virtual}\newcommand{\virtual}{\stepcounter{virtual}\footnotemark[1004]\ifnum \value{virtual}=1 \footnotetext[1004]{Presented virtually.}\fi}
\newcounter{international}\MakePerPage{international}\newcommand{\international}{\stepcounter{international}\footnotemark[1005]\ifnum \value{international}=1 \footnotetext[1005]{International venue.}\fi}
\newcounter{national}\MakePerPage{national}\newcommand{\national}{\stepcounter{national}\footnotemark[1006]\ifnum \value{national}=1 \footnotetext[1006]{National venue.}\fi}
\newcounter{local}\MakePerPage{local}\newcommand{\local}{\stepcounter{local}\footnotemark[1007]\ifnum \value{local}=1 \footnotetext[1007]{Local venue.}\fi}

\renewcommand{\thefootnote}{%
    \ifnum \value{footnote}<10 \fnsymbol{footnote}%
    \else \ifnum \value{footnote}=1000 \textit{S}%
    \else \ifnum \value{footnote}=1001 \textit{\$}%
    \else \ifnum \value{footnote}=1002 \textit{C}%
    \else \ifnum \value{footnote}=1003 $\approx$%
    \else \ifnum \value{footnote}=1004 \textit{$\nu$}%
    \else \ifnum \value{footnote}=1005 $\mathcal{I}$%
    \else \ifnum \value{footnote}=1006 \textit{N}%
    \else \ifnum \value{footnote}=1007 \textit{L}%
    \else \arabic{footnote}%
    \fi\fi\fi\fi\fi\fi\fi\fi\fi%
}



% % here's how to use fixed footnotes with symbol fonts!  https://tex.stackexchange.com/questions/68703/fixfoot-sty-with-symbols
% \usepackage[symbol*,perpage,bottom,para]{footmisc}
% \usepackage{fixfoot}
% \usepackage{etoolbox}% provides \patchcmd
% \makeatletter
% \patchcmd\@fixed@footnote
% {\protected@xdef\@thefnmark{\csname @#1@fftn@footnote\endcsname}}% search
% {\protected@xdef\@thefnmark{%
% 		\expandafter\@fnsymbol\csname @#1@fftn@footnote\endcsname}}% replace
% {}{}% success/failure
% \makeatother

% \DeclareFixedFootnote{\switched}{Switched to my supervision at this point.}
% \DeclareFixedFootnote{\paid}{Expenses paid.}
% \DeclareFixedFootnote{\competitive}{Competitively selected.}
% \DeclareFixedFootnote{\virtual}{Presented virtually.}
% \DeclareFixedFootnote{\compequiv}{Estimated equivalent cost for computational resources.}
% \DeclareFixedFootnote{\international}{International venue.}
% \DeclareFixedFootnote{\national}{National venue.}
% \DeclareFixedFootnote{\local}{Local venue.}





%%
%% Annual Review related annotations
%%

% Comment below to disable annual review annotations
\usepackage{colortbl}
\usepackage{marginnote}

%\newtoggle{ubcformat}
%\toggletrue{ubcformat}

%\newtoggle{annualReview}
%\toggletrue{annualReview}

\iftoggle{annualReview}
{
  \definecolor{newcolor}{RGB}{255,0,0}
  \definecolor{newtablecolor}{RGB}{255,160,160}
  \definecolor{continuingcolor}{RGB}{112,48,160}
  \definecolor{continuingtablecolor}{RGB}{190,161,211}
  %    \definecolor{changedcolor}{rgb}{.376,.290,.482}
  %    \definecolor{changedtablecolor}{rgb}{.702,.635,.780}
  \definecolor{toappearcolor}{rgb}{0,.353,1}
  \definecolor{toappeartablecolor}{rgb}{.612,.733,1}
  \definecolor{changedcolor}{RGB}{0,90,255}
  \definecolor{changedtablecolor}{RGB}{140,181,255}
  \definecolor{acceptedcolor}{RGB}{18,135,25}
  \definecolor{acceptedtablecolor}{RGB}{141,202,145}
  \definecolor{boxcolor}{rgb}{.9,.9,.9}
  \newcommand{\newpic}{\includegraphics[height=9pt]{figs/new}}
  \newcommand{\acceptedpic}{\includegraphics[height=9pt]{figs/accepted}}
  \newcommand{\toappearpic}{\includegraphics[height=9pt]{figs/toappear}}
  \newcommand{\continuingpic}{\includegraphics[height=9pt]{figs/continuing}}
  \newcommand{\changedpic}{\includegraphics[height=9pt]{figs/changed}}
  \newcommand{\new}[1]{\marginnote{\newpic}{\color{newcolor} #1}}
  \newcommand{\accepted}[1]{\marginnote{\acceptedpic}{\color{acceptedcolor} #1}}
  \newcommand{\toappear}[1]{\marginnote{\toappearpic}{\color{toappearcolor} #1}}
  \newcommand{\continuing}[1]{\marginnote{\continuingpic}{\color{continuingcolor} #1}}
  \newcommand{\changed}[1]{\marginnote{\changedpic}{\color{changedcolor} #1}}
  \newcommand{\newtable}{\rowcolor{newtablecolor}\marginnote{\newpic}}
  \newcommand{\continuingtable}{\rowcolor{continuingtablecolor}\marginnote{\continuingpic}}
  \newcommand{\changedtable}{\rowcolor{changedtablecolor}\marginnote{\changedpic}}
  \newcommand{\toonew}[1]{}

  \reversemarginpar
  \usepackage[letterpaper,left=2.5cm,right=2cm,top=.5in,bottom=.5in,marginparwidth=1.7cm,includeheadfoot,headsep=16pt]{geometry}
}
{
  \newcommand{\new}[1]{#1}
  \newcommand{\changed}[1]{#1}
  \newcommand{\continuing}[1]{#1}
  \newcommand{\toappear}[1]{#1}
  \newcommand{\newtable}{}
  \newcommand{\changedtable}{}
  \newcommand{\continuingtable}{}
  \newcommand{\toonew}[1]{}

  \usepackage[letterpaper,left=2.25cm,right=2.25cm,top=.5in,bottom=.5in,marginparwidth=0cm,includeheadfoot,headsep=16pt]{geometry}
}


%%
%% Tables
%%
\usepackage{tabularx}
\usepackage{ragged2e}

\newenvironment{coursetable}{
  \begin{center}
    \begin{longtable}[h!]{ p{0.1\textwidth} p{0.15\textwidth} p{0.07\textwidth} p{0.07\textwidth}
        p{0.1\textwidth} %p{0.1\textwidth} p{0.06\textwidth}
        p{0.19\textwidth} }
      %% The header for the top of the table
      \toprule
      \multicolumn{1}{c}{\bf Session} & \multicolumn{1}{c}{\bf Course} & \multicolumn{1}{c}{\bf Sched.} & \multicolumn{1}{c}{\bf Class} & \multicolumn{2}{c}{\bf Hours Taught}                                                                                                    \\
      \cmidrule(lr){5-6}
                                      & \multicolumn{1}{c}{\bf Number} & \multicolumn{1}{c}{\bf Hours}  & \multicolumn{1}{c}{\bf Size}  & \multicolumn{1}{c}{\bf Lectures} 
                                      %& \multicolumn{1}{c}{\bf Tutorials} & \multicolumn{1}{c}{\bf Labs}
                                      & \multicolumn{1}{c}{\bf Other} \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \multicolumn{1}{c}{\bf Session} & \multicolumn{1}{c}{\bf Course} & \multicolumn{1}{c}{\bf Sched.} & \multicolumn{1}{c}{\bf Class} & \multicolumn{2}{c}{\bf Hours Taught}                                                                                                    \\
      \cmidrule(lr){5-6}
                                      & \multicolumn{1}{c}{\bf Number} & \multicolumn{1}{c}{\bf Hours}  & \multicolumn{1}{c}{\bf Size}  & \multicolumn{1}{c}{\bf Lectures}  
                                      %& \multicolumn{1}{c}{\bf Tutorials} & \multicolumn{1}{c}{\bf Labs}
                                      & \multicolumn{1}{c}{\bf Other} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
      }{
    \end{longtable}
  \end{center}
}

\newenvironment{suptable}{
  \begin{center}
    \begin{longtable}{ p{0.26\textwidth} p{0.24\textwidth} p{0.075\textwidth} p{0.075\textwidth} p{0.27\textwidth} }
      %% The header for the top of the table
      \toprule
      \multicolumn{1}{c}{\bf Student} & \multicolumn{1}{c}{\bf Program} & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}  & \multicolumn{1}{c}{\bf Supervisory Role}                                                                                            \\
      % \cmidrule(lr){3-4}
      %                                      & \multicolumn{1}{c}{\bf Type}    & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}           & \multicolumn{1}{c}{\bf\parbox[t]{0.27\textwidth}{\centering(supervisor, co-supervisor)}} \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \multicolumn{1}{c}{\bf Student} & \multicolumn{1}{c}{\bf Program} & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}  & \multicolumn{1}{c}{\bf Supervisory Role}                                                                                            \\
      % \cmidrule(lr){3-4}
      %                                      & \multicolumn{1}{c}{\bf Type}    & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}           & \multicolumn{1}{c}{\bf\parbox[t]{0.27\textwidth}{\centering(supervisor, co-supervisor)}} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
}{
    \end{longtable}
  \end{center}
}


\newenvironment{supcommtable}{
  \begin{center}
    \begin{longtable}[h!]{ p{0.23\textwidth} p{0.20\textwidth} p{0.07\textwidth} p{0.07\textwidth} p{0.3\textwidth} }
      %% The header for the top of the table
      \toprule
      \multicolumn{1}{c}{\bf Student} & \multicolumn{1}{c}{\bf Program} & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}  & \multicolumn{1}{c}{\bf Committee Type}                                                                                \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \multicolumn{1}{c}{\bf Student Name} & \multicolumn{1}{c}{\bf Program} & \multicolumn{2}{c}{\bf Year}  & \multicolumn{1}{c}{\bf Committee Type}                                                                                \\
      \cmidrule(lr){3-4}
                                           & \multicolumn{1}{c}{\bf Type}    & \multicolumn{1}{c}{\bf Start} & \multicolumn{1}{c}{\bf Finish}         & \multicolumn{1}{c}{\bf\parbox[t]{0.26\textwidth}{\centering(RPE, PhD, MSc)}} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
      }{
    \end{longtable}
  \end{center}
}

\newenvironment{lecttable}{
  \begin{center}
    \begin{longtable}[h!]{ p{0.1\textwidth} p{0.2\textwidth} p{0.07\textwidth} p{0.14\textwidth} p{0.375\textwidth} }
      %% The header for the top of the table
      \toprule
      \multicolumn{1}{c}{\bf Date} & \multicolumn{1}{c}{\bf Event Name} & \multicolumn{1}{c}{\bf Hours} & \multicolumn{1}{c}{\bf Audience} & \multicolumn{1}{c}{\bf Title} \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \multicolumn{1}{c}{\bf Date} & \multicolumn{1}{c}{\bf Event Name} & \multicolumn{1}{c}{\bf Hours} & \multicolumn{1}{c}{\bf Audience} & \multicolumn{1}{c}{\bf Title} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
      }{
    \end{longtable}
  \end{center}
}

\newenvironment{granttable}{
  \begin{center}
    \small
    \begin{longtable}[h!]{
        p{0.17\textwidth}
        p{0.38\textwidth}
        %>{\RaggedLeft\arraybackslash}p{0.03\textwidth}
        >{\RaggedLeft\arraybackslash}p{0.065\textwidth}
        p{0.075\textwidth}
        >{\RaggedRight\arraybackslash}p{0.21\textwidth}
      }
      %% The header for the top of the table
      \toprule
      \textbf{Agency, Program} &
      \textbf{Title} &
      %\textbf{Comp} &
      \textbf{\$/year} &
      \textbf{Year(s)} &
      \textbf{PI \emph{\small{(Co-PIs in italics)}}} \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \textbf{Agency, Program} &
      \textbf{Title} &
      %\textbf{Comp} &
      \textbf{\$/year} &
      \textbf{Year(s)} &
      \textbf{PI \emph{\small{(Co-PIs in italics)}}} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
      }{
    \end{longtable}
  \end{center}
}

\newenvironment{extcomtable}{
  \begin{center}
    \small
    \begin{longtable}[h!]{
        p{0.05\textwidth}
        p{0.2\textwidth}
        p{0.25\textwidth}
        p{0.35\textwidth}
      }
      %% The header for the top of the table
      \toprule
      \textbf{Year} &
      \textbf{Student Name} &
      \textbf{Institution} &
      \textbf{Degree} \\
      \midrule \endfirsthead
      %% The header for the continuation pages
      \toprule
      \textbf{Year} &
      \textbf{Student Name} &
      \textbf{Institution} &
      \textbf{Degree} \\
      \midrule \endhead
      %% Footer for the bottom of the table
      \bottomrule \endlastfoot
      %% Footer for the continued pages
      \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
      }{
    \end{longtable}
  % \begin{center}
  %   \begin{longtable}[h!]{
  %       p{0.2\textwidth}
  %       p{0.05\textwidth}
  %       p{0.2\textwidth}
  %       p{0.2\textwidth}
  %     }
  %     %% The header for the top of the table
  %     \toprule
  %     {\bf Student Name}
  %     & {\bf Year}
  %     & {\bf Institution}
  %     & {\bf Degree}
  %     \\
  %     \midrule \endfirsthead
  %     %% The header for the continuation pages
  %     \toprule
  %     {\bf Student Name}
  %     & {\bf Year}
  %     & {\bf Institution}
  %     & {\bf Degree}
  %     \midrule \endhead
  %     %% Footer for the bottom of the table
  %     \bottomrule \endlastfoot
  %     %% Footer for the continued pages
  %     \bottomrule \footnotesize{\emph{(continued\ldots)}} \endfoot
  %     }{
  %   \end{longtable}
  \end{center}
}



% https://tex.stackexchange.com/questions/5017/center-column-with-specifying-width-in-table-tabular-enviroment
% \newcolumntype{x}[1]{>{\centering\arraybackslash\hspace{0pt}}p{#1\textwidth}}
\newcolumntype{x}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}

% Dashed line
\usepackage{arydshln}



% Better looking two-line headers. Depends on multirow package
% place on the "second" line, and leave space above.
\newcommand{\thead}[1]{
  \multirow{-2}{*}{
    \hspace{-13pt} % RG: Why is there extra space?
    % RG: Get the font and boldface right (reverting to roman)
    \begin{bf}
      \begin{sffamily}
        \begin{tabular}{@{}l@{}}
          #1
        \end{tabular}
      \end{sffamily}
    \end{bf}
  }
}


% Decide whether to include or exclude free-form prose
% Include for internal reviews (e.g. 3rd Year Review); exclude for external CV
%\includecomment{blurb}
\excludecomment{blurb}


% get rid of auto-spacing before and after tables
%\setlength\LTpre{\smallskipamount} % RG: Why doesn't 0pt work?
\setlength\LTpre{0pt}
\setlength\LTpost{0pt}
\newcommand{\tbold}[1]{\textbf{#1}}

\newcommand{\denselist}{\itemsep-3pt\topsep-6pt\partopsep-6pt}
\newcommand{\tailspace}{}


% DJS way, instead of KLB way, to change section layout
\titleformat{\section}{\normalfont\bfseries}{\arabic{section}.}{.29in}{}
\titleformat{\subsection}{\normalfont\itshape}{(\alph{subsection})}{.19in}{}
\renewcommand\thesection{\arabic{section}}
\renewcommand\thesubsection{\thesection(\alph{subsection})}

% % change sections and subsections: taken from article.cls -- KLB
% \makeatletter
% \renewcommand\thesection{\@arabic\c@section.\hspace{.19in}}
% \renewcommand\thesubsection{\@arabic\c@section.\@arabic\c@subsection.\hspace{.19in}}
% \renewcommand\section{\@startsection {section}{1}{\z@}%
%   {-3.5ex \@plus -1ex \@minus -.2ex}%
%   {2.3ex \@plus.2ex}%
%   %                                   {\normalfont\Large\bfseries}}
%   {\normalfont\bfseries}}
% \renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
%   {-3.25ex\@plus -1ex \@minus -.2ex}%
%   {1.5ex \@plus .2ex}%
%   %                                     {\normalfont\large\bfseries}}
%   {\normalfont\itshape}}
% \makeatother
% % TODO: better would be something like https://tex.stackexchange.com/a/234223/9019

% Make "C++" look good
\newcommand{\Cpp}{C\kern-0.05em\texttt{+\kern-0.03em+}}

% Macro
\newcommand{\TODO}[1]{{\textcolor{red}{[TODO: #1]}}}

% Sections that aren't actually there
\iftoggle{ubcformat}
{
    \newcommand{\nasection}[1]{\addtocounter{section}{1}}
    \newcommand{\nasubsection}[1]{\addtocounter{subsection}{1}}
}{
    \newcommand{\nasection}[1]{}
    \newcommand{\nasubsection}[1]{}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage[hidelinks]{hyperref}


%% --------------------
%% Bib related
\usepackage[backend=biber,sorting=none,style=numeric,citestyle=numeric,maxbibnames=12,giveninits=false,defernumbers=true,doi=false,url=false]{biblatex}

% Reduce spacing between references
\setlength\bibitemsep{.2\baselineskip}

\setlength\bibparsep{.2\baselineskip}
%% Show abstract, which is actually used for collaboration info.
\DeclareFieldFormat{abstract}{\small\textit{#1}}
%\renewbibmacro*{finentry}{\printfield{abstract}\finentry}


% TODO: would be nice to link to the article a la % https://tex.stackexchange.com/a/48506/9019
% except incorporating eprint links...which seems nontrivial?

%% Bibtex filters
\defbibfilter{journal}{
  keyword=journal and not keyword=noreview and not keyword=submission
}
\defbibfilter{journalnoreview}{
  keyword=journal and keyword=noreview and not keyword=submission
}
\defbibfilter{conf}{
  keyword=conference and not keyword=noreview and not keyword=submission
}
\defbibfilter{confnoreview}{
  keyword=conference and keyword=noreview and not keyword=submission
}
\defbibfilter{workshop}{
  keyword=workshop and not keyword=noreview and not keyword=submission
}
\defbibfilter{workshopnoreview}{
  keyword=workshop and keyword=noreview and not keyword=submission
}
\defbibfilter{noreview}{
  ( keyword=tech-report or keyword=noreview ) and not keyword=submission
}
\defbibfilter{submission}{
  keyword=submission
}

% handle pubstate = {toappear}
% https://tex.stackexchange.com/a/408041/9019
\NewBibliographyString{toappear}
\DefineBibliographyStrings{english}{%
  toappear = {to appear},
}

\renewbibmacro*{in:}{}
%\renewbibmacro*{in:}{%
%  \iffieldundef{pubstate}
%    {}
%    {\printfield{pubstate}%
%     \setunit{\addspace}%
%     \clearfield{pubstate}}%
%  \printtext{%
%    \bibstring{in}\intitlepunct}}

% handle author annotations: equal, mystudent, me
\newcommand{\bibeqcon}{\ensuremath{^{\boldsymbol\star}}}
\renewcommand*{\mkbibcompletename}[1]{%
    \ifitemannotation{me}%
        {\textcolor{orange!70!black}{#1}}%
        {\ifitemannotation{mystudent}%
            {\textbf{#1}}%
            {#1}}%
    \ifitemannotation{equal}%
        {\bibeqcon}%
    {}}
% \renewcommand*{\mkbibnamegiven}[1]{%
%   \ifitemannotation{me}%
%     {#1}%{\textbf{#1}}%
%     {\ifitemannotation{mystudent}{\textbf{#1}}{#1}}}
% \renewcommand*{\mkbibnamefamily}[1]{%
%   \ifitemannotation{me}%
%     {#1}%{\textbf{#1}}%
%     {\ifitemannotation{mystudent}{\textbf{#1}}{#1}}%
%   \ifitemannotation{equal}
%     {\bibeqcon}
%     {}%
% }


%%
%% For reverse ordering of references
%% https://tex.stackexchange.com/a/625292/9019

\makeatletter
\newcounter{bibenvcounter}
\newcounter{bibitemcounter}[bibenvcounter]

\newcommand*{\auxkacz@envmax}[2]{%
  \csgdef{blxkacz@envmax@#1}{#2}}

\def\blx@thelabelnumber{%
  \begingroup
  \nottoggle{blx@skiplab}
    {\iftoggle{blx@labelnumber}
       {\ifundef\abx@field@shorthand
         % Need to know if we set any localnumber from .aux file, not
         % just current item. Otherwise, we may just write new
         % localnumbers but not existing ones
         % Also, don't want to regenerate localnumber for any key in a
         % refsection which we've already seen because this has the nasty
         % side-effect of incrementing the localnum counter
         % Also, have to create localnumber again if \nocite{*} as items
         % could have been added to the .bib file without changing the cite
         % information in the .tex
         {\ifboolexpr { (not togl {blx@localnumber}
                         or
                         test {\ifinlist{*}\blx@nocites})
                         and
                         not test {\ifcsdef{blx@defer@\the\c@refsection @\blx@refcontext@context @\abx@field@entrykey}} }
            {\iftoggle{blx@omitnumbers}
               {\let\abx@field@localnumber\@empty}
               {\ifcsundef{blxkacz@envmax@\the\value{bibenvcounter}}
                  {\blx@rerun@latex
                   \csdef{blxkacz@envmax@\the\value{bibenvcounter}}{0}}
                  {\csnumgdef{blx@labelnumber@\the\c@refsection}{%
                   \csuse{blxkacz@envmax@\the\value{bibenvcounter}}%
                      -\value{bibitemcounter}}%
                   \edef\abx@field@localnumber{%
                    \csuse{blx@labelnumber@\the\c@refsection}}%
                  \blx@bbl@addentryfield{\abx@field@entrykey}{\the\c@refsection}%
                  {localnumber}{\blx@refcontext@context}{\abx@field@localnumber}}}}
            {}%
          % Issue re-run message if there was no localnumber in the .aux and
          % \nocite{*} was used because this means that an entry was added to the .bib
          % and was not yet recorded in the .aux. We will have generated a localnumber
          % for such a case above and now we need to re-run to make sure it's in the .aux
          % for the next run
          \ifboolexpr { test {\ifinlist{*}\blx@nocites}
                        and
                        not test {\ifcsdef{blx@localnumber@\the\c@refsection @\abx@field@entrykey}} }
            {\blx@rerun@latex}
            {}%
          % If localnumbers were already in the .aux, add them
          % again from the .aux. This prevents some cycling
          % problems where pagebreaks change after localnumber
          % settles down and then we need another run which then
          % regenerates localnumber requiring another run but then
          % the pagebreaks change back again ... etc.
          \ifcsundef{blx@defer@\the\c@refsection @\blx@refcontext@context @\abx@field@entrykey}
            {\ifundef\abx@field@localnumber
               {}
               {\listxadd\blx@localnumaux{%
                  \string\abx@aux@number%
                     {\the\c@instcount}%
                     {\abx@field@entrykey}%
                     {\the\c@refsection}%
                     {\blx@refcontext@context}%
                     {\abx@field@localnumber}}%
                   % record that we have already generated and output localnum
                   % for this key in this refsection/refcontext
                   \global\cslet{blx@defer@\the\c@refsection @\blx@refcontext@context @\abx@field@entrykey}\@empty}}
           {}}
         {}}%
       {}}
    {}%
  \endgroup}

\defbibenvironment{bibliography}
  {\stepcounter{bibenvcounter}%
   \list
     {\stepcounter{bibitemcounter}%
      \printtext[labelnumberwidth]{%
        \printfield{labelprefix}%
        \printfield{labelnumber}}}
     {\setlength{\labelwidth}{\labelnumberwidth}%
      \setlength{\leftmargin}{\labelwidth}%
      \setlength{\labelsep}{\biblabelsep}%
      \addtolength{\leftmargin}{\labelsep}%
      \setlength{\itemsep}{\bibitemsep}%
      \setlength{\parsep}{\bibparsep}}%
      \renewcommand*{\makelabel}[1]{\hss##1}}
  {\endlist
   \blx@auxwrite\@mainaux{}{%
     \string\auxkacz@envmax
       {\the\value{bibenvcounter}}
       {\the\value{bibitemcounter}}}}
  {\item}
\makeatother



%%
%% Adding Markup to new bib entries (use keyword new)
%%
%% Adapted from here: https://tex.stackexchange.com/questions/411043/biblatex-add-an-image-in-a-bib-entry
\renewbibmacro*{begentry}{%
  \ifkeyword{new}{%
    \new{}%
  }{}%
  \ifkeyword{accepted}{%
    \accepted{}%
  }{}%
  \ifkeyword{changed}{%
    \changed{}%
  }{}%
  \ifkeyword{toappear}{%
    \toappear{}%
  }{}%
}

%%
%% Acceptance rate field
%%
%% Adapted from https://tex.stackexchange.com/questions/111846/biblatex-2-custom-fields-only-one-is-working

\usepackage[many]{tcolorbox} % shaded boxes
\newcommand{\rightsymb}[1]{{% set up
      \parfillskip=0pt % so \par doesn't push \square to left
      \widowpenalty=10000 % so we don't break the page before \square
      \displaywidowpenalty=10000 % ditto
      \finalhyphendemerits=0 % TeXbook exercise 14.32
      %
      % horizontal
      \leavevmode % \nobreak means lines not pages
      \unskip % remove previous space or glue
      \nobreak % don't break lines
      \hfil % ragged right if we spill over
      \penalty50 % discouragement to do so
      \hskip.2em % ensure some space
      \null % anchor following \hfill
      \hfill % push text to right
      #1% the text to right justify
      %
      % vertical
      \par}} % build paragraph

\colorlet{ARdarkcolor}{black!35!white}
\colorlet{ARlightcolor}{white!96!black}
\colorlet{ARtextcolor}{black!60!white}

\newtcbox{\ARbox}{enhanced,nobeforeafter,tcbox raise base, boxrule=0.4pt, top=-0.4mm, bottom=-0.8mm, right=0mm, left=3.5mm,arc=1pt,boxsep=2pt,before upper={\vphantom{dlg}},   colframe=ARdarkcolor,coltext=ARtextcolor,colback=ARlightcolor, overlay={\begin{tcbclipinterior}\fill[ARdarkcolor] (frame.south west) rectangle node[text=white,font=\sffamily\bfseries\tiny,rotate=90]{AR} ([xshift=3.3mm]frame.north west);\end{tcbclipinterior}}}

\newcommand{\ARtext}[1]{%
  \colorlet{saved}{.}\colorlet{ARdarkcolor}{saved!35!white}\colorlet{ARlightcolor}{white!96!saved}\colorlet{ARtextcolor}{saved!60!white}
  \ARbox{\sffamily\footnotesize\textcolor{ARtextcolor}{#1}}}
\newcommand{\AR}[1]{\rightsymb{\ARtext{#1}}}

\newtcbox{\citesbox}{enhanced,nobeforeafter,tcbox raise base, boxrule=0.4pt, top=-0.4mm, bottom=-0.4mm, right=0mm, left=0mm,arc=1pt,boxsep=2pt,before upper={\vphantom{dlg}}, colframe=ARdarkcolor,coltext=ARtextcolor,colback=ARlightcolor}
\newcommand{\citestext}[1]{%
  \colorlet{saved}{.}\colorlet{ARdarkcolor}{saved!35!white}\colorlet{ARlightcolor}{white!83!saved}\colorlet{ARtextcolor}{saved!60!white} \citesbox{\sffamily\footnotesize\textcolor{ARtextcolor}{#1 cites}}}

\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{ % turn arinfo into usera for rendering purposes
      \step[fieldsource=arinfo]
      \step[fieldset=usera,origfieldval]
    }
  }
}
\iftoggle{ubcformat}{
\DeclareSourcemap{
  \maps[datatype=bibtex]{
    \map{ % turn collabinfo into abstract to print it
      \step[fieldsource=collabinfo]
      \step[fieldset=abstract,origfieldval]
    }
    \map[overwrite]{ % strip eprint (arXiv) info from published papers
      \step[fieldsource=keywords,notmatch=\regexp{submitted|tech-report},final]
      \step[fieldset=eprint,fieldvalue=]
    }
  }
}
}{}

% \DeclareFieldFormat{usera}{\sloppy{\ARtext{#1}}
\DeclareFieldFormat{usera}{\ARtext{#1}}

\DeclareFieldFormat{addendum}{\textbf{#1}}

% \AtEveryBibitem{% put at start of entry
% }

\input{ubc-cv-citation-info.tex}

% now in ubc-cv-citation-info.tex so it can loop over thresholds
% \AtEveryBibitem{%
%   \csappto{blx@bbx@\thefield{entrytype}}{% put at end of entry
%     \rightsymb{%
%       \iffieldundef{usera}{\space}{\space\printfield{usera}}%
%       \ifkeyword{cites1000}{\citestext{$\ge 1\,000$}}{}%
%       \ifkeyword{cites500}{\citestext{$\ge 500$}}{}%
%       \ifkeyword{cites100}{\citestext{$\ge 100$}}{}%
%       \ifkeyword{cites50}{\citestext{$\ge 50$}}{}%
%       \ifkeyword{cites10}{\citestext{$\ge 10$}}{}%
%       % \ifkeyword{cites1000}{$\;$\includegraphics[height=9pt]{figs/1000-cites.pdf}}{}%
%       % \ifkeyword{cites100}{$\;$\includegraphics[height=9pt]{figs/100-cites.pdf}}{}%
%       % \ifkeyword{cites10}{$\;$\includegraphics[height=9pt]{figs/10-cites.pdf}}{}%
%     }
%   }
% }

% \newcommand{\remark}[1]{\fontsize{8}{9}\selectfont#1\fontsize{11}{12}\selectfont}
\newcommand{\remark}[1]{{\footnotesize#1}}
\newcommand{\remarkk}[1]{{\footnotesize\par}} % paragraph break so that the paragraph ends with the small font; causes the whole paragraph's baseline to be the small font's baseline
% \newcommand{\remarkk}[1]{\fontsize{8}{9}\selectfont#1\par\fontsize{11}{12}\selectfont} % paragraph break so that the paragraph ends with the small font; causes the whole paragraph's baseline to be the small font's baseline
\newcommand{\tremark}[1]{\vspace{-2em}\par\noindent{\small#1}}
